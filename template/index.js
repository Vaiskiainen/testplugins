(function(r,i,d,_,c){"use strict";const a=[],s=i.findByProps("_channelMessages"),o=i.findByProps("updateMessageRecord","createMessageRecord"),u=i.findByName("MessageRecord",!1),g=i.findByName("RowManager");a.push(_.before("dispatch",d.FluxDispatcher,function([t]){if(t.type==="MESSAGE_DELETE"){if(t.__vml_cleanup)return t;const e=s.get(t.channelId)?.get(t.id);return!e||e.author?.id=="1"||e.state=="SEND_FAILED"?t:(c.storage.nopk&&fetch(`https://api.pluralkit.me/v2/messages/${encodeURIComponent(e.id)}`).then(function(n){return n.json()}).then(function(n){e.id===n.original&&!n.member?.keep_proxy&&d.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",id:e.id,channelId:e.channel_id,__vml_cleanup:!0})}),[{message:{...e.toJS(),__vml_deleted:!0},type:"MESSAGE_UPDATE"}])}})),a.push(_.before("dispatch",d.FluxDispatcher,function([t]){if(t.type!=="MESSAGE_UPDATE")return;const e=t.message,n=s.get(e?.channel_id);if(!n)return;const l=n.get(e.id);if(l)return e.content!==l.content&&(e.__vml_edited=!0,e.__vml_edits=[...l.__vml_edits??[],{timestamp:Date.now(),oldContent:l.content,newContent:e.content}]),t})),a.push(_.after("generate",g.prototype,function([t],e){t.rowType===1&&(t.message.__vml_deleted&&(e.message.edited="deleted",e.backgroundHighlight??={},e.backgroundHighlight.backgroundColor=d.ReactNative.processColor("#da373c22"),e.backgroundHighlight.gutterColor=d.ReactNative.processColor("#da373cff")),t.message.__vml_edited&&(e.message.edited="edited",e.backgroundHighlight??={},e.backgroundHighlight.backgroundColor=d.ReactNative.processColor("#eab30822"),e.backgroundHighlight.gutterColor=d.ReactNative.processColor("#eab308ff")))})),a.push(_.instead("updateMessageRecord",o,function([t,e],n){return e.__vml_deleted||e.__vml_edited?o.createMessageRecord(e,t.reactions):n.apply(this,[t,e])})),a.push(_.after("createMessageRecord",o,function([t],e){e.__vml_deleted=t.__vml_deleted,e.__vml_edited=t.__vml_edited,e.__vml_edits=t.__vml_edits??[]})),a.push(_.after("default",u,function([t],e){e.__vml_deleted=!!t.__vml_deleted,e.__vml_edited=!!t.__vml_edited,e.__vml_edits=t.__vml_edits??[]}));const h=function(){a.forEach(function(t){return t()});for(const t in s._channelMessages)for(const e of s._channelMessages[t]._array)e.__vml_deleted&&d.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",id:e.id,channelId:e.channel_id,__vml_cleanup:!0})};return r.onUnload=h,r})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin);
