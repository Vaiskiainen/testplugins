(function(c,s,d,a,u){"use strict";const i=[],o=s.findByProps("_channelMessages"),l=s.findByProps("updateMessageRecord","createMessageRecord"),g=s.findByName("MessageRecord",!1),p=s.findByName("RowManager");i.push(a.before("dispatch",d.FluxDispatcher,function([t]){if(t.type==="MESSAGE_DELETE"){if(t.__vml_cleanup)return t;const e=o.get(t.channelId)?.get(t.id);return!e||e.author?.id=="1"||e.state=="SEND_FAILED"?t:(u.storage.nopk&&fetch(`https://api.pluralkit.me/v2/messages/${encodeURIComponent(e.id)}`).then(function(n){return n.json()}).then(function(n){e.id===n.original&&!n.member?.keep_proxy&&d.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",id:e.id,channelId:e.channel_id,__vml_cleanup:!0})}),[{message:{...e.toJS(),__vml_deleted:!0},type:"MESSAGE_UPDATE"}])}})),i.push(a.before("dispatch",d.FluxDispatcher,function([t]){if(t.type!=="MESSAGE_UPDATE")return;const e=t.message,n=o.get(e?.channel_id);if(!n)return;const _=n.get(e.id);if(_)return e.content!==_.content&&(e.__vml_edited=!0,e.__vml_edits=[..._.__vml_edits??[],{timestamp:Date.now(),oldContent:_.content,newContent:e.content}]),t})),i.push(a.after("generate",p.prototype,function([t],e){if(t.rowType!==1)return;const n=t.message;if(n.__vml_deleted&&(e.message.edited="deleted",e.backgroundHighlight??={},e.backgroundHighlight.backgroundColor=d.ReactNative.processColor("#da373c22"),e.backgroundHighlight.gutterColor=d.ReactNative.processColor("#da373cff")),n.__vml_edited&&(e.message.edited="edited",e.backgroundHighlight??={},e.backgroundHighlight.backgroundColor=d.ReactNative.processColor("#eab30822"),e.backgroundHighlight.gutterColor=d.ReactNative.processColor("#eab308ff")),n.__vml_edits?.length>0){const _=n.__vml_edits.map(function(r){return`[Edited ${new Date(r.timestamp).toLocaleString()}]: ${r.oldContent} \u2192 ${r.newContent}`}),f=e.message.content??"";e.message.content=_.join(`
`)+`
`+f}})),i.push(a.instead("updateMessageRecord",l,function([t,e],n){return e.__vml_deleted||e.__vml_edited?l.createMessageRecord(e,t.reactions):n.apply(this,[t,e])})),i.push(a.after("createMessageRecord",l,function([t],e){e.__vml_deleted=t.__vml_deleted,e.__vml_edited=t.__vml_edited,e.__vml_edits=t.__vml_edits??[]})),i.push(a.after("default",g,function([t],e){e.__vml_deleted=!!t.__vml_deleted,e.__vml_edited=!!t.__vml_edited,e.__vml_edits=t.__vml_edits??[]}));const h=function(){i.forEach(function(t){return t()});for(const t in o._channelMessages)for(const e of o._channelMessages[t]._array)e.__vml_deleted&&d.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",id:e.id,channelId:e.channel_id,__vml_cleanup:!0})};return c.onUnload=h,c})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin);
