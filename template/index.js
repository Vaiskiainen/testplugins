(function(l,s,d,_,c){"use strict";const i=[],o=s.findByProps("_channelMessages"),r=s.findByProps("updateMessageRecord","createMessageRecord"),u=s.findByName("MessageRecord",!1),g=s.findByName("RowManager");i.push(_.before("dispatch",d.FluxDispatcher,function([t]){if(t.type==="MESSAGE_DELETE"){if(t.__vml_cleanup)return t;const e=o.get(t.channelId)?.get(t.id);return!e||e.author?.id=="1"||e.state=="SEND_FAILED"?t:(c.storage.nopk&&fetch(`https://api.pluralkit.me/v2/messages/${encodeURIComponent(e.id)}`).then(function(n){return n.json()}).then(function(n){e.id===n.original&&!n.member?.keep_proxy&&d.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",id:e.id,channelId:e.channel_id,__vml_cleanup:!0})}),[{message:{...e.toJS(),__vml_deleted:!0},type:"MESSAGE_UPDATE"}])}})),i.push(_.before("dispatch",d.FluxDispatcher,function([t]){if(t.type!=="MESSAGE_UPDATE")return;const e=t.message,n=o.get(e?.channel_id);if(!n)return;const a=n.get(e.id);if(a)return e.content!==a.content&&(e.__vml_edited=!0,e.__vml_edits=[...a.__vml_edits??[],{timestamp:Date.now(),oldContent:a.content,newContent:e.content}]),t})),i.push(_.after("generate",g.prototype,function([t],e){if(t.rowType===1&&(t.message.__vml_deleted&&(e.message.edited="deleted",e.backgroundHighlight??={},e.backgroundHighlight.backgroundColor=d.ReactNative.processColor("#da373c22"),e.backgroundHighlight.gutterColor=d.ReactNative.processColor("#da373cff")),t.message.__vml_edited&&(e.message.edited="edited",e.backgroundHighlight??={},e.backgroundHighlight.backgroundColor=d.ReactNative.processColor("#eab30822"),e.backgroundHighlight.gutterColor=d.ReactNative.processColor("#eab308ff")),t.message.__vml_edits?.length>0)){const n=t.message.__vml_edits.map(function(a){return`${new Date(a.timestamp).toLocaleString()}: ${a.oldContent} \u2192 ${a.newContent}`}).join(`
`);e.renderHeader=function(){return React.createElement("Text",{style:{color:"#eab308",fontSize:12,marginLeft:12,marginBottom:4}},n)}}})),i.push(_.instead("updateMessageRecord",r,function([t,e],n){return e.__vml_deleted||e.__vml_edited?r.createMessageRecord(e,t.reactions):n.apply(this,[t,e])})),i.push(_.after("createMessageRecord",r,function([t],e){e.__vml_deleted=t.__vml_deleted,e.__vml_edited=t.__vml_edited,e.__vml_edits=t.__vml_edits??[]})),i.push(_.after("default",u,function([t],e){e.__vml_deleted=!!t.__vml_deleted,e.__vml_edited=!!t.__vml_edited,e.__vml_edits=t.__vml_edits??[]}));const f=function(){i.forEach(function(t){return t()});for(const t in o._channelMessages)for(const e of o._channelMessages[t]._array)e.__vml_deleted&&d.FluxDispatcher.dispatch({type:"MESSAGE_DELETE",id:e.id,channelId:e.channel_id,__vml_cleanup:!0})};return l.onUnload=f,l})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin);
